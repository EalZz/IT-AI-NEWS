name: Daily Zero-Cost AI News Pipeline

on:
  push:
    branches:
      - master
      - main
  schedule:
    # KST 07시 50분(UTC 22시 50분)부터 23시 50분(UTC 14시 50분)까지만 매시 50분 실행
    # KST 00시 50분~06시 50분은 수면 모드
    - cron: '50 22,23,0-14 * * *'
  workflow_dispatch: # GitHub Repository 웹사이트 Action 탭에서 수동 실행 버튼 표시

permissions:
  contents: write # 봇이 저장소에 메모리 파일을 저장할 수 있는 쓰기 권한

jobs:
  run-daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: 저장소 코드 체크아웃 (가져오기)
        uses: actions/checkout@v3

      - name: Python 3.10 환경 설정
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 파이프라인 구동용 라이브러리 설치
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 뉴스 에이전트 구동 (크롤링 -> 단기기억 필터 -> Gemini 평가/요약 -> 디스코드 알림)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python main.py

      - name: 메모리(보낸 뉴스 상태)를 GitHub 저장소에 동기화
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add *.json || echo "No state file to add"
          git commit -m "chore: save sent articles state" || echo "No changes to commit"
          git push
